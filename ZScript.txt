CLASS SiegeHammer : Brutalweapon
{
	Default
	
	{
	Weapon.AmmoUse1 0;
	Weapon.AmmoUse2 0;
	Weapon.AmmoGive1 0;
	Weapon.AmmoGive2 0;
	Weapon.AmmoType1 "SoulAmmo";
	Obituary "%o was smooshed by %k's Hammer.";
    Inventory.PickupSound "RAILINSR";
	Inventory.Pickupmessage "You got the Siege Hammer! (Slot 1)";
	+WEAPON.NOAUTOAIM;
	+WEAPON.NOALERT;
	+WEAPON.EXPLOSIVE;
	Weapon.SelectionOrder 1550;
	Inventory.AltHUDIcon "SRCGA0";
	BrutalWeapon.weight 7;


	}
	
	
		action void A_DoHammer(double range, double ang)
			{	
				Vector3 viewPos = (pos.xy, player.viewz); // player view point
				Vector3 viewDir = (AngleToVector(angle, cos(pitch)), -sin(pitch)); // player view direction
				double maxAngle = cos(ang);
    
				let it = ThinkerIterator.Create("Actor", STAT_DEFAULT);
						Actor mo;
					while (mo = Actor(it.Next()))
			{
				// get the object's bounding box
				Vector3 rel = mo.PosRelative(CurSector); // account for sector portals
				Vector3 minBox = rel - (mo.radius, mo.radius, 0);
				Vector3 maxBox = rel + (mo.radius, mo.radius, mo.height);
        
				// get the point on the box nearest the view point
				Vector3 nearest;
				nearest.x = max(minBox.x, min(viewPos.x, maxBox.x));
				nearest.y = max(minBox.y, min(viewPos.y, maxBox.y));
				nearest.z = max(minBox.z, min(viewPos.z, maxBox.z));
        
				Vector3 dir = nearest - viewPos;
				double dist = dir.Length();
				if (dist > 0)
				{
					if (dist > range) // is it in range?
						continue;
            
					if (viewDir dot (dir / dist) < maxAngle) // is it within an acceptable angle?
						continue;
						
					If (!invoker.owner.CheckSight(mo,SF_IGNOREWATERBOUNDARY))
						continue;
						
				
				}
					If(mo.species == "marines")
						Continue;
				If(mo.bshootable || mo.bmissile)
				{
					If(mo.bspawnceiling || mo.health < 1 || mo is "headkicking" || mo is "BDECGRASS" || mo is "Brutal_Bloodspot" || mo is "BaseHeadShot")
					{
						Continue;
					}
					
					Vector3 HammerCoords = LevelLocals.SphericalCoords(mo.pos,invoker.owner.pos);
					
					If(mo.bmissile)
					{
						actor PreviousTarget;
						If(mo.target)
						{
							previoustarget = mo.target;
						}
						mo.target = invoker.owner;
						mo.pitch = (mo.pitch - 180);
						mo.angle = (mo.angle - 180);
						mo.vel.x = -mo.vel.x;
						mo.vel.y = -mo.vel.y;
						mo.vel.z = -mo.vel.z;
						If(previousTarget)
						{
							mo.tracer = previoustarget;
						}
					}
					
					Else
					{
						
						mo.vel3dfromangle(25,invoker.owner.angleto(mo,TRUE),random(-20,-40));
						mo.damagemobj(invoker,invoker.owner,frandom(200,500),"normal",DMG_THRUSTLESS);
						If(!mo.bnoblood)
						{
							vector3 bloodspawn = mo.pos;
							bloodspawn.z = (bloodspawn.z + (mo.height * 0.5));
							
							Mo.spawnblood(bloodspawn,invoker.owner.angleto(mo,TRUE),1);
						}
						
					}
					
				}
				
					Continue;
				
        // grab it
        break;
    }
}
	States
	{
	
		GrenadeThrowFlash:
			RAIS ABCD 1;
			TNT1 A 24;
			RAIS DCBA 1;//32 in total
			stop;
			
		FuckYouFlash:
			RAIK ABCDEEEEEEEEEEEEEEEEEEEEEEDCBA 1; //18
			stop;
			
		KickingFlash:
			RAIK ABCDEEEEEEEEEEDCBA 1;
			Goto Ready;
		AirKickingFlash:
			RAIK ABCDEEEEEEEEEEDCBA 1; //18
			Goto Ready;
	
		SlideKickingStart:
			RAIK ABCDE 1;
			RAIK EEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEEE 1 { //39 total
				if (CountInv("Kicking") == 0) {
					return resolvestate("SlideKickingEnd");
				}
				return resolvestate(null);
			}
			Goto Ready;

		SlideKickingEnd:
			RAIK EEEEEEDCBA 1; //10
			Goto Ready;
			
		SprintOverlay:
			RAIK ABCDE 1;
			Wait;
	
		ReturnfromSprint:
			RAIK DCBA 1;
			Goto ready;
	
		Select:
			TNT1 A 0;
			NULL A 0{if(GetCVAR("bd_SmartCrosshairs") == 1){A_SetCrosshair(GetCVAR("RailgunCrosshair"));}else{A_SetCrosshair(0);}}
			Goto SelectFirstPersonLegs;
		SelectContinue: "####" A 0 A_GiveInventory("IsPlayingDoxMod",1); 
			UNHG A 0 A_takeinventory("disabletilting",1);
			TNT1 AAAAAAAAAAAAAA 0 A_Raise();
			TNT1 A 1 A_Raise();
		ReturnFromNothing:
			TNT1 A 0 A_startSound("RAILINSR",1);
			TNT1 AAA 0;
		
			Goto SelectAnimation;
		
		SelectAnimation:
			NULL A 0{if(GetCVAR("bd_SmartCrosshairs") == 1){A_SetCrosshair(GetCVAR("RailgunCrosshair"));}else{A_SetCrosshair(0);}}
			RAIS DCBA 1 A_WeaponReady(WRF_NOFIRE);
			GOto Ready;
			Deselect: 
				"####" A 0 A_TakeInventory("IsPlayingDoxMod",1);
				"####" A 0 A_ClearOverlays(-2,-2);
				RAIS ABCD 1;
				TNT1 A 0 A_StopSOund(1);
				TNT1 A 0 A_StopSOund(2);
				TNT1 A 0 A_StopSOund(6);
				TNT1 A 0 A_TakeInventory("TossGrenade", 1);
				TNT1 AAAAAAAAAAAAAAAA 0 A_lower();
				TNT1 A 1 A_Lower();
				Wait;
		Ready:
			HAMR A 1 A_weaponreadyDX(WRF_ALLOWRELOAD);
			LOOP;
			
		Fire:
			HAMR BCDEEEEEE 1;// A_SetPitch(pitch-10, SPF_INTERPOLATE);
			HAMR EE 1;
			HAMR EFG 1; //A_SetPitch(pitch+5, SPF_INTERPOLATE);
		//FireHold:
			HAMR H 1
			{
				Radius_Quake(4,14,0,12,0);
				A_DoHammer(300,90);
				If(countinv("soulammo") < 30)
				{
					A_damageself(20,"desintegrate");
				}
				takeinventory("soulammo",30);
				//A_SetPitch(pitch-7, SPF_INTERPOLATE);
			}
			HAMR IJJJJJJJJJJJJ 1 A_WeaponOffset( random(3,-3) , 32+random(3,-3), 0);
			HAMR J 17;
			//TNT1 A 0 A_refire("firehold");
			HAMR JGFEDCB 1;
			Goto ready;

	
		Spawn:
			HAMP A 1;
			LOOP;

		
	}
	
}